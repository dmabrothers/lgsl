<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>GSL FFI interface &mdash; Documentation for LGSL v0.1</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Documentation for LGSL v0.1" href="index.html" />
    <link rel="prev" title="LGSL Examples" href="examples.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="examples.html" title="LGSL Examples"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Documentation for LGSL v0.1</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="gsl-ffi-interface">
<span id="id1"></span><h1>GSL FFI interface<a class="headerlink" href="#gsl-ffi-interface" title="Permalink to this headline">¶</a></h1>
<p>In this chapter we are going to explain the direct GSL interface to use the C functions provided by the GSL library directly.</p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The access to the C GSL functions is possible thanks to the FFI library provided by LuaJIT.
The FFI module allows one to call any C function available from the dynamic libraries currently loaded, directly from Lua code.</p>
<p>Some of the modules available in LGSL are reimplemented in Lua using the FFI interface and the basic GSL functions for BLAS and linear algebra.</p>
<p>For example, the module for non-linear fitting has been completely reimplemented in Lua using the FFI interface.
Thanks to the capability of LuaJIT to generate highly optimized code on the fly, the Lua implementation runs at a speed comparable to compiled optimized C code.
For the ODE systems LuaJIT is in general comparable to C in terms of speed.
Another module re-implemented in Lua is the module for numerical integration, where the QAG adaptive routine has been ported with excellent results.</p>
<p>The non-linear fit module reimplemented in Lua has been checked for correctness using a subset of the <a class="reference external" href="http://www.itl.nist.gov/div898/strd/nls/nls_main.shtml">NIST datasets</a>.</p>
<p>You can run the tests yourself by giving the following command.</p>
<p>Then you can compare the results and the plots to the official results published in the NIST website.</p>
<p>Here is an example of the plot produced for the ENSO dataset:</p>
<div class="figure">
<img alt="_images/lmfit-enso-dataset-plot.png" src="_images/lmfit-enso-dataset-plot.png" />
</div>
</div>
<div class="section" id="id2">
<h2>GSL FFI interface<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<span class="target" id="module-gsl"></span><p>The usage of the GSL FFI interface is done using the <a class="reference internal" href="#module-gsl" title="gsl"><tt class="xref py py-mod docutils literal"><span class="pre">gsl</span></tt></a> module.
This module contains all the GSL functions available and you can call them directly from Lua code.
Because direct usage of the GSL functions is considered &#8220;expert mode&#8221;, the <a class="reference internal" href="#module-gsl" title="gsl"><tt class="xref py py-mod docutils literal"><span class="pre">gsl</span></tt></a> module is not loaded by default when requiring the parent module <tt class="xref py py-mod docutils literal"><span class="pre">lgsl</span></tt>.</p>
<p>Let us see a simple example:</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">-- we load the gsl module</span>
<span class="n">gsl</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">lgsl.gsl&quot;</span><span class="p">)</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">lgsl.matrix&quot;</span><span class="p">)</span>

<span class="c1">-- we define a new matrix</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="k">do</span>
  <span class="k">for</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="k">do</span>
    <span class="n">gsl</span><span class="p">.</span><span class="n">gsl_matrix_set</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>As you can see we are just using the GSL function <tt class="xref py py-func docutils literal"><span class="pre">gsl_matrix_set()</span></tt> to set the value each of element of the matrix.</p>
<p>There are a few things that are important to note.
The C function that we have used has the following signature <tt class="docutils literal"><span class="pre">void</span> <span class="pre">gsl_matrix_set(gsl_matrix</span> <span class="pre">*m,</span> <span class="pre">int</span> <span class="pre">i,</span> <span class="pre">int</span> <span class="pre">j,</span> <span class="pre">double</span> <span class="pre">x)</span></tt>.
When you call it from Lua, the arguments are converted to the appropriate C types using a set of rules specific to the <a class="reference external" href="http://luajit.org/ext_ffi_semantics.html">FFI semantics</a>.
The implementation of LGSL ensures that a matrix object can actually be converted to a <tt class="docutils literal"><span class="pre">gsl_matrix</span></tt> pointer.
As for the other arguments, note that the Lua numbers are converted to integer or double as appropriate to match the C function signature.
If the arguments cannot be converted to the appropriate type, an error is raised.</p>
<p>Another thing that you may note is that we have ignored the value returned by the GSL function.
In general, the return value can signal an error condition and it could be necessary to check the returned value.
For this purpose, LGSL offers a simple helper function in <tt class="xref py py-mod docutils literal"><span class="pre">gsl-check</span></tt>. We illustrate its usage by continuing upon the previous example:</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="n">gsl_check</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">lgsl.gsl-check&quot;</span><span class="p">)</span>

<span class="n">gsl_check</span><span class="p">(</span><span class="n">gsl</span><span class="p">.</span><span class="n">gsl_matrix_add</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">m</span><span class="p">))</span> <span class="c1">-- this should pass</span>
<span class="n">gsl_check</span><span class="p">(</span><span class="n">gsl</span><span class="p">.</span><span class="n">gsl_matrix_add</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">matrix</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span> <span class="c1">-- this should raise an error</span>
</pre></div>
</div>
<p>The function <tt class="xref py py-func docutils literal"><span class="pre">gsl_check()</span></tt> above just checks the returned value of the <tt class="xref py py-func docutils literal"><span class="pre">gsl.gsl_matrix_add()</span></tt> call and raises an error with an appropriate message if needed. In the second call in the example above, it will generate the error: <tt class="docutils literal"><span class="pre">&quot;ERROR:</span> <span class="pre">matrices</span> <span class="pre">must</span> <span class="pre">have</span> <span class="pre">same</span> <span class="pre">dimensions&quot;</span></tt>.</p>
<p>Finally note that the indexing convention when calling <tt class="xref py py-func docutils literal"><span class="pre">gsl.gsl_matrix_set()</span></tt> is the C convention where the first index is 0.
This fact is a direct implication of the fact that we are directly calling the C function defined in the GSL library.</p>
</div>
<div class="section" id="gsl-ffi-examples">
<h2>GSL FFI examples<a class="headerlink" href="#gsl-ffi-examples" title="Permalink to this headline">¶</a></h2>
<p>If you want to learn more about the usage of the GSL FFI interface, you may take a look at the implementation file of the <a class="reference internal" href="bsplines.html#module-bspline" title="bspline"><tt class="xref py py-mod docutils literal"><span class="pre">bspline</span></tt></a> module.</p>
<p>The file is quite small and easy to understand, and it illustrates all the important aspects of the GSL FFI interface.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">GSL FFI interface</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#id2">GSL FFI interface</a></li>
<li><a class="reference internal" href="#gsl-ffi-examples">GSL FFI examples</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="examples.html"
                        title="previous chapter">LGSL Examples</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/gsl-ffi.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="examples.html" title="LGSL Examples"
             >previous</a> |</li>
        <li><a href="index.html">Documentation for LGSL v0.1</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2016, Francesco Abbate, Lesley De Cruz, Benjamin von Ardenne.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>